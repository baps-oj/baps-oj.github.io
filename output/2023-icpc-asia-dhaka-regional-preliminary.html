<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="baps-engineering-team Blog Posts">
    <title>What went wrong on ICPC-Asia Dhaka Regional Preli 2023</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
    <link rel="stylesheet" type="text/css" href="http://baps-oj.github.io/theme/papyrus/static/css/main.css" />
    <link rel="stylesheet" type="text/css" href="http://baps-oj.github.io/theme/papyrus/static/css/pygment.css" />
    <link rel="shortcut icon" href="http://baps-oj.github.io/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="http://baps-oj.github.io/theme/papyrus/static/css/stork.css">
    <link rel="stylesheet" media="screen and (prefers-color-scheme: dark)"
        href="http://baps-oj.github.io/theme/papyrus/static/css/stork-dark.css">
    <link
        href="http://baps-oj.github.io/feeds/all.atom.xml"
        type="application/atom+xml" rel="alternate" title="baps-engineering-team Atom Feed" />
<meta name="description" content="2023 ICPC Asia Dhaka Regional Preliminary" />
</head>

<body class="min-h-screen flex flex-col max-w-7xl lg:max-w-none text-zinc-800 bg-neutral-100 
    dark:bg-neutral-900 dark:text-zinc-300 container mx-auto justify-center md:px-3 ">
    <script>
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia(
                '(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <nav class="sm:flex sm:justify-between xl:ml-32 pl-4 items-center">
        <div class="flex pt-4">
            <h1 class="font-semibold text-2xl"><a href="http://baps-oj.github.io/">baps-engineering-team</a></h1>
            <button id="theme-toggle" type="button" aria-label="Light|Dark"
                class="text-zinc-700 dark:text-zinc-400 rounded-full focus:outline-none text-sm ml-2 p-1">
                <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                </svg>
                <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                        fill-rule="evenodd" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        <ul class="flex flex-wrap lg:mr-24 md:pt-0">
            <li class="mr-4 pt-6"><a  href="http://baps-oj.github.io/archives.html">Archive</a></li>
            <li class="mr-4 pt-6"><a                     href="http://baps-oj.github.io/categories.html">Categories</a></li>
            <li class="mr-4 pt-6"><a  href="http://baps-oj.github.io/tags.html">Tags</a></li>
            <li class="mr-4 pt-6"><a  href="http://baps-oj.github.io/search.html">Search</a></li>
        </ul>
    </nav>
    <div class="flex-grow md:max-w-screen-md md:mx-auto md:w-3/4 px-4">
        <nav class="text-zinc-800 dark:text-zinc-300 mt-12 pb-2 md:mt-16" aria-label="Breadcrumb">
            <ul class="p-0 inline-flex items-center">
                <li class="flex items-center">
                    <a href="http://baps-oj.github.io/" class="text-zinc-800 dark:text-zinc-300 inline-flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z">
                            </path>
                        </svg>
                        Home
                    </a>
                    <svg class="fill-current w-3 h-3 mr-2 ml-1" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 320 512">
                        <path
                            d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z" />
                    </svg>
                </li>
                <li class="flex items-center">
                    <a href="http://baps-oj.github.io/categories.html">Categories</a>
                    <svg class="fill-current w-3 h-3 mr-2 ml-1" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 320 512">
                        <path
                            d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z" />
                    </svg>
                </li>
                <li class="flex items-center">
                    <a href="http://baps-oj.github.io/category/icpc.html">ICPC</a>
                    <svg class="fill-current w-3 h-3 mr-2 ml-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                        <path
                            d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z" />
                    </svg>
                </li>
            </ul>
        </nav>

<main>
  <header>
    <h1 class="font-semibold text-3xl my-2">What went wrong on ICPC-Asia Dhaka Regional Preli 2023</h1>
    <footer class="flex text-sm text-zinc-800 dark:text-zinc-400">
      <div class="flex text-xs text-zinc-800 dark:text-zinc-400">
        <time>November 04, 2023</time>
        <div>
          <span>&nbsp;·&nbsp;5 min read</span>
        </div>
        <div>
          <span>&nbsp;·&nbsp;Mehedi Shafi</span>
        </div>
      </div>
    </footer>
    <div class="flex text-xs text-zinc-800 dark:text-zinc-400">
      <span>Last updated: December 24, 2023</span>
    </div>
  </header>
  <div class="max-w-7xl container mx-auto my-8 text-zinc-800 dark:text-zinc-300  
              prose lg:max-w-none prose-headings:text-zinc-800 prose-headings:dark:text-zinc-300 
              prose-h1:text-3xl lg:prose-h1:text-3xl prose-headings:font-semibold 
              prose-pre:bg-zinc-200 prose-pre:text-zinc-800
              dark:prose-pre:bg-zinc-800 dark:prose-pre:text-zinc-200
              prose-blockquote:text-zinc-800
              dark:prose-blockquote:text-zinc-200
              prose-a:text-slate-600 prose-a:font-normal
              dark:prose-a:text-slate-400
              dark:prose-strong:text-zinc-200 
              dark:prose-code:text-zinc-200
              dark:prose-code:bg-zinc-800
              prose-code:bg-zinc-200
              prose-code:font-light
              prose-img:rounded-md
              sm:text-left md:text-justify
              ">
    <h1>Preface on BAPS OJ</h1>
<p>BAPS is a voluntary organization that works for improving quality of programmers and programming in Bangladesh. They are also usually responsible for setting problems for ICPC Regional Dhaka site. To host a contest we need a platform that is fast, non-commercial and reliable. Until 2023 CodeMarshal was being used for this purpose. But as a legacy system it had its plethora of issues and outdated stack making it very hard to scale and maintain. That raised the necessity of BAPS to have their own platform fulfilling all check boxes mentioned above. The dream of BAPS OJ started with the main goal being "A fast, reliable and cheap online contest platform where students can contest, practice and universities can take the leverage of it.". The second point is that as BAPS itself is a voluntary organization, BAPS OJ will live up to the same principal and the OJ will be maintained by the community itself. Everyone in the community will own this platform if they wish to.</p>
<blockquote>
<p><a href="https://baps-oj.github.io/2023-icpc-asia-dhaka-regional-and-baps.html">Read the announcement by baps</a></p>
</blockquote>
<h3>What is this blog about</h3>
<p>On 13th October 23 BAPS OJ had its first large scale contest. It was a disaster for the platform to say the least. Before this we had a mock contest where the load was low. Everything comes into play when we'll dive deep into the details.</p>
<p>First I want to begin by saying how terribly sorry we are even today for the incident. As an ex-contestant I completely agree with the emotion of the community on that day and how horrible every member of the team felt during and after the event.</p>
<h3>So what happened?</h3>
<p>On the preli we had 2464 teams across the country. Each team containing 3 members. Raising the active users count to 7500. With judges, coaches, public users the total number of users reached nearly 10000. This is the least important thing we need to remember, as throughout the 4h 30m contest the number of failed request was less than 500 out of nearly a million requests. Let's look into the basic system diagram on how our system works.</p>
<p><img alt="system-diagram-simplified" src="./images/system-diagram-simplified.jpg"></p>
<blockquote>
<p>Note that, this is a very top level simplified view.</p>
</blockquote>
<p>The frontend and backend was completely redisgned along with database and caches. Only old portion of the system is the code execution sandbox that we took from CodeMarshal due to the complexity and re innovation necessary to build a code sandbox. There are tons of gotcha and cases that a sandbox needs to handle. Which is why we decided it's not worth the pain to do it for the first run and we wanted the contestant to have somewhat familiarity with the behavior of the sandbox.</p>
<p>Now to understand what went wrong we need to dig a bit deeper into the architecture of the sandbox. Don't worry I will not bore you with this portion. Only the input and output of the sandbox. So how the sandbox work is that you give it a code and i/o files and it returns you the output generated by the executed code. But the process is not be synchronous. It's an asynchronous system that uses an internal queue to pick next execution. And we push code to be executed in this queue. There are N worker nodes that can execute a code and stores the output to be fetched by upstream service at a delayed pace. It is not a push mechanism which results in a buffer between the result being ready and displayed to the users.</p>
<p>That's it no more design stuff. Let's actually talk what happened.</p>
<p>We had 24 worker node at the beginning of the contest for our sandbox during the preli. Meaning capability of executing 20 codes at any given point. During the preli the peak number of submission per minute was ~45. Note that this was not always the case. We scaled to 45 workers during first half hour of the contest. By that time peak submission count was somewhere around ~30 per minute. So all good then why the scaling didn't help us?</p>
<p>At the beginning our backend had 24 async workers to communicate and monitor execution of codes with the sandbox. The ratio was somewhat (1:1). I say somewhat because in two async components it's not guaranteed which worker of one system gets assigned to which of the other system. And when at the beginning our async workers were blocked trying to finish execution, we assumed (mistake 1) that we need more workers in our backend. And that's what we did. We scaled up to 104 workers for our backend. Now, note that execution is not the only async task in the backend. There are many others. And hence they got blocked then as well. So scaling up to 104 seemingly helped moving submissions from queued state to running state. As all workers picked one submission and started working on judging it. But there came the second mistake. And it was a big one.</p>
<p>We have 104 workers working in backend to work with 104 submissions at a time while we have 45 codesandbox executing code. For each 104 submissions it was around 700 code executions to finish (taking test cases in consideration). But since the number of workers at backend was more than twice of what sandbox had, it was executing test cases for whichever backend execution reached the sandbox fast. Making some (a lot of) submissions waiting for their all test cases to be executed. This resulted in the RUNNING queue growing over time. This is what we failed to detect during the contest that the RUNNING state submissions were not failed totally rather were partially judged. We should have continued from where it failed execution instead of requeing them.</p>
<p>When we finally understood the root cause it was 1 and half hour after the contest had ended. We deployed several fixes at that time and finished judging with expected speed. And we rejudged all submissions of problem G as requested by judges within an hour and change.</p>
<p><strong>In short the solution DDoSed our sandbox service.</strong></p>
<p>What have we done to improve this?</p>
<ul>
<li>We separated worker pool for different job so other tasks like, rank generation and other bots of ours do not block execution of submissions.</li>
<li>We ensured that at no point of time auto-scaling increases backend worker count for submission execution is not more than sandbox workers.</li>
<li>We ensured that in case a submission fails with our effort it will be automatically retried from last finished test-case with a reserved pool of both backend and execution worker.</li>
<li>We enabled extensive monitoring in our sandbox to ensure we understand what it's doing at any given point of time.</li>
</ul>
<p>The result of the improvement is the onsite. We hope everyone had a fantastic onsite. And once again we're grateful to every contestant and organizers to give us another chance to prove ourselves.</p>
<h3>What's next?</h3>
<p>We understand our sandbox is not yet comparable of those what are available presently, we're planning to improve in terms speed, resilience and consistency.</p>
    <!-- <div class="aspect-w-16 aspect-h-9 mx-auto"></div> CSS placeholder -->
  </div>
  <footer class="flex flex-col mt-10 ">
    <ul class="flex flex-wrap">
        <li
          class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
          <a href="http://baps-oj.github.io/tag/bubt.html">bubt</a>
        </li>
        <li
          class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
          <a href="http://baps-oj.github.io/tag/dhaka-regional.html">dhaka-regional</a>
        </li>
        <li
          class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
          <a href="http://baps-oj.github.io/tag/icpc.html">icpc</a>
        </li>
        <li
          class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
          <a href="http://baps-oj.github.io/tag/preli.html">preli</a>
        </li>
        <li
          class="bg-zinc-200 hover:bg-zinc-300 dark:hover:bg-zinc-800 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 mb-2 mr-2 px-3 py-1.5 rounded-md transition ease-in active:-translate-y-1 active:scale-110 duration-75">
          <a href="http://baps-oj.github.io/tag/tech.html">tech</a>
        </li>
    </ul>
    <div class="flex w-full my-2 bg-zinc-200 dark:bg-zinc-700 rounded-lg">
      <div class="w-1/2 hover:bg-zinc-300 dark:hover:bg-zinc-800 rounded-l-lg">
        <a class="flex flex-col pr-2" href="http://baps-oj.github.io/2023-icpc-asia-dhaka-regional-and-baps.html">
          <div class="mx-4 py-2 text-left">
            <p class="text-zinc-600 dark:text-zinc-300 text-sm">« PREV PAGE</p>
            <p class="text-left py-1 hover:underline">2023 ICPC Asia Dhaka Regional and BAPS</p>
          </div>
        </a>
      </div>
    </div>
  </footer>
  <div>
  </div>
</main>

    </div>
    <footer class="flex w-full text-xs justify-center mt-10 mb-6 text-zinc-600 dark:text-zinc-400">
        <div class="px-4">
            <span></span>Powered by
            <a class="underline" href="https://getpelican.com/">Pelican</a>&nbsp;&
            <a class="underline" href="https://github.com/aleylara/Papyrus">Papyrus</a>
        </div>
    </footer>


    <script>
        let themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        let themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia(
                '(prefers-color-scheme: dark)').matches)) {
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
        }
        let themeToggleBtn = document.getElementById('theme-toggle');
        themeToggleBtn.addEventListener('click', function () {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
        });
    </script>
</body>

</html>